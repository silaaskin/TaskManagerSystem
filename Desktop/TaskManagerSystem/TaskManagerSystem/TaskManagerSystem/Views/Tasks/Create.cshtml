@model TaskManagerSystem.Models.UserTask
@{
    ViewData["Title"] = "Yeni Görev";
    Layout = "_Layout";

    var userList = ViewBag.Users as List<TaskManagerSystem.Models.User>;
    var userRole = Context.Session.GetString("UserRole");
}

<style>
    .form-control, .form-select {
        background: rgba(45,45,70,.6) !important;
        border: 1px solid rgba(255,255,255,.1) !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 12px 18px !important;
    }

        .form-control::placeholder {
            color: rgba(255,255,255,.5);
        }

    .glass-card {
        background: #27293d;
        border-radius: 20px;
    }

    /* DOSYA KARTLARI */
    .file-card {
        background: rgba(255,255,255,.05);
        border: 1px solid rgba(255,255,255,.1);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
    }

    .file-preview {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.5rem;
    }

        .file-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

    .file-preview-pdf {
        background: #dc2626;
    }

    .file-preview-image {
        background: #7c3aed;
    }

    .file-preview-doc {
        background: #2563eb;
    }

    .file-preview-excel {
        background: #059669;
    }

    .file-actions {
        display: flex;
        gap: 8px;
    }
</style>

<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <div class="glass-card p-5 shadow-lg">

            <h3 class="fw-bold mb-4 text-white">
                <i class="fa-solid fa-plus-circle text-info me-2"></i>Yeni Görev Oluştur
            </h3>

            <form asp-action="Create" method="post" enctype="multipart/form-data" id="taskForm">

                @* ADMIN: kullanıcı atama *@
                @if (userRole == "Admin" && userList != null)
                {
                    <div class="mb-4 p-3 rounded" style="background:rgba(186,84,245,.1);border:1px solid #ba54f5;">
                        <label class="form-label text-info small fw-bold">
                            <i class="fa-solid fa-user-tag me-1"></i>Görevi Atanacak Kullanıcı
                        </label>
                        <select class="form-select" name="assignedUserId">
                            <option value="">Kendime Ata</option>
                            @foreach (var u in userList)
                            {
                                <option value="@u.Id">@u.Name (@u.Email)</option>
                            }
                        </select>
                    </div>
                }

                @* TEMEL BİLGİLER *@
                <div class="mb-3">
                    <label class="form-label text-white-50 small">Görev Başlığı</label>
                    <input type="text" name="title" class="form-control" required placeholder="Neler yapacaksın?" />
                </div>

                <div class="mb-3">
                    <label class="form-label text-white-50 small">Açıklama</label>
                    <textarea name="description" class="form-control" rows="4" placeholder="Detaylar..."></textarea>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label text-white-50 small">Kategori</label>
                        <select class="form-select" name="category" required>
                            <option value="1">İş</option>
                            <option value="2">Kişisel</option>
                            <option value="3">Diğer</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white-50 small">Bitiş Tarihi</label>
                        <input type="date" name="dueDate" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-white-50 small">Bitiş Saati</label>
                        <input type="time" name="dueTime" class="form-control" required />
                    </div>
                </div>

                <hr class="border-light opacity-25" />

                @* DOSYA EKLEME *@
                <h6 class="text-success mb-2">
                    <i class="fa-solid fa-paperclip me-1"></i>Dosya Ekle
                </h6>

                <div class="input-group mb-3">
                    <input type="file"
                           id="fileInput"
                           name="attachments"
                           class="form-control"
                           multiple
                           accept=".pdf,.png,.jpg,.jpeg,.docx,.xlsx" />
                    <button type="button" class="btn btn-success" onclick="addFiles()">Ekle</button>
                </div>

                <div id="fileList"></div>

                @* BUTONLAR *@
                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-lg px-5 rounded-pill"
                            style="background:#ba54f5;color:white">
                        <i class="fa-solid fa-save me-2"></i>Kaydet
                    </button>
                    <a href="/Tasks/Index" class="btn btn-lg btn-outline-light px-5 rounded-pill">
                        <i class="fa-solid fa-times me-2"></i>İptal
                    </a>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    let selectedFiles = [];

    function addFiles() {
        const input = document.getElementById("fileInput");
        selectedFiles = [...selectedFiles, ...Array.from(input.files)];
        updateFileList();
    }

    function updateFileList() {
        const list = document.getElementById("fileList");
        list.innerHTML = "";

        selectedFiles.forEach((file, index) => {
            const ext = file.name.split('.').pop().toLowerCase();
            let preview = '<i class="fa-solid fa-file"></i>';
            let cls = "file-preview";

            if (ext === "pdf") { cls += " file-preview-pdf"; preview = '<i class="fa-solid fa-file-pdf"></i>'; }
            else if (["png", "jpg", "jpeg"].includes(ext)) {
                cls += " file-preview-image";
                preview = `<img src="${URL.createObjectURL(file)}">`;
            }
            else if (ext === "docx") { cls += " file-preview-doc"; preview = '<i class="fa-solid fa-file-word"></i>'; }
            else if (ext === "xlsx") { cls += " file-preview-excel"; preview = '<i class="fa-solid fa-file-excel"></i>'; }

            list.innerHTML += `
            <div class="file-card">
                <div class="${cls}">${preview}</div>
                <div class="flex-grow-1 text-white fw-bold">${file.name}</div>
                <div class="file-actions">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="previewFile(${index})">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadFile(${index})">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>`;
        });
    }

    function previewFile(i) {
        window.open(URL.createObjectURL(selectedFiles[i]), "_blank");
    }

    function downloadFile(i) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(selectedFiles[i]);
        a.download = selectedFiles[i].name;
        a.click();
    }

    function removeFile(i) {
        selectedFiles.splice(i, 1);
        updateFileList();
    }

    document.getElementById("taskForm").addEventListener("submit", () => {
        const dt = new DataTransfer();
        selectedFiles.forEach(f => dt.items.add(f));
        document.getElementById("fileInput").files = dt.files;
    });
</script>
